"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));function _createForOfIteratorHelper(a,b){var c="undefined"!=typeof Symbol&&a[Symbol.iterator]||a["@@iterator"];if(!c){if(Array.isArray(a)||(c=_unsupportedIterableToArray(a))||b&&a&&"number"==typeof a.length){c&&(a=c);var d=0,e=function(){};return{s:e,n:function n(){return d>=a.length?{done:!0}:{done:!1,value:a[d++]}},e:function e(a){throw a},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var f,g=!0,h=!1;return{s:function s(){c=c.call(a)},n:function n(){var a=c.next();return g=a.done,a},e:function e(a){h=!0,f=a},f:function f(){try{g||null==c["return"]||c["return"]()}finally{if(h)throw f}}}}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(a):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=Array(b);c<b;c++)d[c]=a[c];return d}var _require=require("../lib/db"),localDb=_require.localDb,remoteDb=_require.remoteDb,_require2=require("../enums/accountType"),accountType=_require2.accountType,getSellerTurnover=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b){var c;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,remoteDb.raw("\n    SELECT SUM(GP_TOTALTTC) as turnover\n    FROM PIECE \n    WHERE \n    convert(varchar(10), GP_DATECREATION, 102) = convert(varchar(10), getdate(), 102) AND\n    GP_NATUREPIECEG = 'FFO' AND\n    GP_REPRESENTANT = :sellerId  \n  ",{sellerId:b});case 2:return c=a.sent,a.abrupt("return",c[0].turnover);case 4:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),byStore=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c){var d,e;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=remoteDb("ETABLISS").select({turnover:remoteDb.raw("SUM(CASE WHEN GP_TOTALTTC IS NOT NULL THEN GP_TOTALTTC ELSE 0 END)"),unboundTurnover:remoteDb.raw("SUM(CASE WHEN GP_REPRESENTANT = '' THEN GP_TOTALTTC ELSE 0 END)"),storeId:"ET_ETABLISSEMENT",storeName:"ET_LIBELLE"}).joinRaw("LEFT JOIN PIECE ON GP_ETABLISSEMENT = ET_ETABLISSEMENT AND convert(varchar(10), GP_DATECREATION, 102) = convert(varchar(10), getdate(), 102) AND GP_NATUREPIECEG = 'FFO'").groupBy("ET_ETABLISSEMENT","ET_LIBELLE").orderBy("ET_LIBELLE","ASC"),void 0!==b&&d.whereIn("ET_ETABLISSEMENT",b),a.next=4,d;case 4:return e=a.sent,c&&(e=e.filter(function(a){return a.storeName.toUpperCase().includes(c.toUpperCase().trim())})),e=e.sort(function(c,a){return c.turnover>a.turnover?-1:c.turnover<a.turnover?1:0}),a.abrupt("return",e);case 8:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),bySeller=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b){var c,d,e,f,g,h,i;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c=[],d=remoteDb("PIECE").select({turnover:remoteDb.raw("SUM(CASE WHEN GP_TOTALTTC IS NOT NULL THEN GP_TOTALTTC ELSE 0 END)"),sellerCegidId:"GP_REPRESENTANT",sellerCegidName:remoteDb.raw("MAX(GCL_LIBELLE)")}).innerJoin("COMMERCIAL","GCL_COMMERCIAL","GP_REPRESENTANT").where("GP_NATUREPIECEG","FFO").whereRaw("convert(varchar(10), GP_DATECREATION, 102) = convert(varchar(10), getdate(), 102)").groupBy("GP_REPRESENTANT"),void 0!==b&&d.whereIn("GP_ETABLISSEMENT",b),a.next=5,d;case 5:e=a.sent,f=_createForOfIteratorHelper(e),a.prev=7,f.s();case 9:if((g=f.n()).done){a.next=17;break}return h=g.value,a.next=13,localDb("users").where("accountType",accountType.SellerAccount).where("cegidId",h.sellerCegidId).first();case 13:i=a.sent,i?c.push({name:i.username,id:i.id,turnover:h.turnover}):c.push({name:h.sellerCegidName,id:0,turnover:h.turnover});case 15:a.next=9;break;case 17:a.next=22;break;case 19:a.prev=19,a.t0=a["catch"](7),f.e(a.t0);case 22:return a.prev=22,f.f(),a.finish(22);case 25:return c=c.sort(function(c,a){return c.turnover>a.turnover?1:c.turnover<a.turnover?-1:0}),a.abrupt("return",c);case 27:case"end":return a.stop();}},a,null,[[7,19,22,25]])}));return function(){return a.apply(this,arguments)}}();module.exports={getSellerTurnover:getSellerTurnover,byStore:byStore,bySeller:bySeller};