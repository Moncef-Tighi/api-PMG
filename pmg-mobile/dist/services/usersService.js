"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));function _createForOfIteratorHelper(i,j){var b="undefined"!=typeof Symbol&&i[Symbol.iterator]||i["@@iterator"];if(!b){if(Array.isArray(i)||(b=_unsupportedIterableToArray(i))||j&&i&&"number"==typeof i.length){b&&(i=b);var k=0,l=function(){};return{s:l,n:function(){return k>=i.length?{done:!0}:{done:!1,value:i[k++]}},e:function(b){throw b},f:l}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var e,m=!0,n=!1;return{s:function(){b=b.call(i)},n:function(){var c=b.next();return m=c.done,c},e:function(b){n=!0,e=b},f:function a(){try{m||null==b["return"]||b["return"]()}finally{if(n)throw a}}}}function _unsupportedIterableToArray(d,a){if(d){if("string"==typeof d)return _arrayLikeToArray(d,a);var b=Object.prototype.toString.call(d).slice(8,-1);return"Object"===b&&d.constructor&&(b=d.constructor.name),"Map"===b||"Set"===b?Array.from(d):"Arguments"===b||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(b)?_arrayLikeToArray(d,a):void 0}}function _arrayLikeToArray(e,a){(null==a||a>e.length)&&(a=e.length);for(var f=0,g=Array(a);f<a;f++)g[f]=e[f];return g}function ownKeys(e,a){var b=Object.keys(e);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);a&&(c=c.filter(function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable})),b.push.apply(b,c)}return b}function _objectSpread(d){for(var a,e=1;e<arguments.length;e++)a=null==arguments[e]?{}:arguments[e],e%2?ownKeys(Object(a),!0).forEach(function(b){(0,_defineProperty2["default"])(d,b,a[b])}):Object.getOwnPropertyDescriptors?Object.defineProperties(d,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach(function(b){Object.defineProperty(d,b,Object.getOwnPropertyDescriptor(a,b))});return d}var bcrypt=require("bcrypt"),abilitiesManager=require("../services/abilitiesManager"),_require=require("../lib/db"),localDb=_require.localDb,remoteDb=_require.remoteDb,_require2=require("../enums/accountType"),accountType=_require2.accountType,_require3=require("../lib/debug"),d_auth=_require3.d_auth,checkLogin=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function f(g,b){var c,h;return _regenerator["default"].wrap(function(d){for(;;)switch(d.prev=d.next){case 0:return d.next=2,localDb("users").where("disabled",!1).whereRaw("UPPER(username) = ?",g.toUpperCase()).limit(1).first();case 2:if(c=d.sent,c){d.next=5;break}return d.abrupt("return",!1);case 5:if(h=bcrypt.compareSync(b,c.password),h){d.next=8;break}return d.abrupt("return",!1);case 8:return d.abrupt("return",c.id);case 9:case"end":return d.stop();}},f)}));return function(){return b.apply(this,arguments)}}(),getUserById=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function f(g){var b,h,i;return _regenerator["default"].wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,localDb("users").where("id",g).limit(1).first();case 2:if(b=c.sent,b){c.next=5;break}return c.abrupt("return");case 5:if(delete b.password,b.accountType!==accountType.SellerAccount){c.next=17;break}return c.next=9,remoteDb("dbo.COMMERCIAL").where("GCL_COMMERCIAL",b.cegidId).first();case 9:if(h=c.sent,h){c.next=13;break}return d_auth("Count not find cegid seller for the following local user %O",b),c.abrupt("return");case 13:b.defaultStore=h.GCL_ETABLISSEMENT,b.cegidRole="SELLER",c.next=25;break;case 17:return c.next=19,remoteDb("dbo.UTILISAT").where("US_UTILISATEUR",b.cegidId).first();case 19:if(i=c.sent,i){c.next=23;break}return d_auth("Could not find cegid user for the following local user %O",b),c.abrupt("return");case 23:b.defaultStore=i.US_ETABLISSEMENT,b.cegidRole=i.US_GROUPE;case 25:return b.defaultStore&&!b.accessStores.includes(b.defaultStore)&&b.accessStores.push(b.defaultStore),c.abrupt("return",b);case 27:case"end":return c.stop();}},f)}));return function(){return b.apply(this,arguments)}}(),updateLastSeen=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function c(d){return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.next=2,localDb("users").update({lastSeen:localDb.fn.now()}).where("id",d);case 2:case"end":return b.stop();}},c)}));return function(){return b.apply(this,arguments)}}(),updateUser=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function f(g,b){var c,h;return _regenerator["default"].wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(!b.username){d.next=6;break}return d.next=3,localDb("users").where("username",b.username).where("id","<>",g).first();case 3:if(c=d.sent,!c){d.next=6;break}return d.abrupt("return",{error:"Le nom d'utilisateur est d\xE9ja pris"});case 6:if("string"==typeof b.password&&(b.password=bcrypt.hashSync(b.password,3)),!b.accessStores){d.next=12;break}return d.next=10,getUserById(g);case 10:h=d.sent,b.accessStores=b.accessStores.filter(function(b){return b!==h.defaultStore});case 12:return d.abrupt("return",localDb("users").update(b).where("id",g));case 13:case"end":return d.stop();}},f)}));return function(){return b.apply(this,arguments)}}(),importUser=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function i(j,b,c){var d,k,l,m;return _regenerator["default"].wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return c.accountType="SELLER"===b?accountType.SellerAccount:accountType.UserAccount,e.next=3,localDb("users").orWhere(function(b){b.where("cegidId",j).where("accountType",c.accountType)}).orWhere("username",c.username).limit(1).first();case 3:if(d=e.sent,!d){e.next=6;break}return e.abrupt("return",{error:d.username===c.username?"Le nom d'utilisateur est d\xE9ja pris":"Utilisateur d\xE9ja import\xE9"});case 6:if(c.password=bcrypt.hashSync(c.password,3),c.accountType!==accountType.SellerAccount){e.next=16;break}return e.next=10,remoteDb("COMMERCIAL").select("GCL_ETABLISSEMENT").where("GCL_COMMERCIAL",j).first();case 10:if(l=e.sent,l){e.next=13;break}return e.abrupt("return",{error:"Commercial (".concat(j,") introuvable sur la bdd cegid")});case 13:k=l.GCL_ETABLISSEMENT,e.next=24;break;case 16:return e.next=18,remoteDb("dbo.UTILISAT").select("US_ETABLISSEMENT","US_GROUPE").where("US_UTILISATEUR",j).first();case 18:if(m=e.sent,m){e.next=21;break}return e.abrupt("return",{error:"Utilisateur (".concat(j,") introuvable sur la bdd cegid")});case 21:if(abilitiesManager.canHandleCegidRole(m.US_GROUPE)){e.next=23;break}return e.abrupt("return",{error:"Role non g\xE9r\xE9 ".concat(m.US_GROUPE)});case 23:k=m.US_ETABLISSEMENT;case 24:return c.accessStores=c.accessStores.filter(function(b){return b!==k}),e.abrupt("return",localDb("users").insert(_objectSpread(_objectSpread({},c),{},{cegidId:j})));case 26:case"end":return e.stop();}},i)}));return function(){return b.apply(this,arguments)}}(),listLocalAndRemoteProfiles=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function f(){var g,h,i,j;return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return g=[],b.next=3,localDb("users").select(localDb.raw("users.*"),localDb.raw("uc.username as \"createdBy\""),localDb.raw("uu.username as \"updatedBy\"")).joinRaw("LEFT JOIN users uc ON (\"users\".\"createdById\" = uc.id)").joinRaw("LEFT JOIN users uu ON (\"users\".\"updatedById\" = uu.id)");case 3:return h=b.sent.map(function(b){return _objectSpread(_objectSpread({},b),{},{password:void 0})}),b.next=6,remoteDb("UTILISAT").select("US_UTILISATEUR","US_ABREGE","US_ETABLISSEMENT","US_GROUPE").whereIn("US_GROUPE",abilitiesManager.getManagedCegidRoles());case 6:return i=b.sent,b.next=9,remoteDb("COMMERCIAL").select("GCL_COMMERCIAL","GCL_LIBELLE","GCL_ETABLISSEMENT");case 9:return j=b.sent,h=h.reduce(function(d,e){if(e.accountType===accountType.UserAccount){var a=i.find(function(b){return b.US_UTILISATEUR===e.cegidId});if(!a)return d;if(e.defaultStore=a.US_ETABLISSEMENT,e.cegidRole=a.US_GROUPE,!abilitiesManager.canHandleCegidRole(e.cegidRole))return d}else{var b=j.find(function(b){return b.GCL_COMMERCIAL===e.cegidId});if(!b)return d;e.defaultStore=b.GCL_ETABLISSEMENT,e.cegidRole="SELLER"}return e.defaultStore&&!e.accessStores.includes(e.defaultStore)&&e.accessStores.push(e.defaultStore),d.push(e),d},[]),g.push.apply(g,(0,_toConsumableArray2["default"])(h)),i=i.reduce(function(c,d){return h.find(function(b){return b.accountType===accountType.UserAccount&&b.cegidId===d.US_UTILISATEUR})?c:abilitiesManager.canHandleCegidRole(d.US_GROUPE)?(c.push({cegidId:d.US_UTILISATEUR,username:d.US_ABREGE,defaultStore:d.US_ETABLISSEMENT,cegidRole:d.US_GROUPE,disabled:!1,accessStores:[d.US_ETABLISSEMENT],accessZones:[]}),c):c},[]),g.push.apply(g,(0,_toConsumableArray2["default"])(i)),j=j.reduce(function(c,d){return h.find(function(b){return b.accountType===accountType.SellerAccount&&b.cegidId===d.GCL_COMMERCIAL})?c:(c.push({cegidId:d.GCL_COMMERCIAL,username:d.GCL_LIBELLE,defaultStore:d.GCL_ETABLISSEMENT,cegidRole:"SELLER",disabled:!1,accessStores:[d.GCL_ETABLISSEMENT],accessZones:[]}),c)},[]),g.push.apply(g,(0,_toConsumableArray2["default"])(j)),b.abrupt("return",g);case 17:case"end":return b.stop();}},f)}));return function(){return b.apply(this,arguments)}}(),listLocalSellers=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function j(k){var l,m,b,n,o,p,q;return _regenerator["default"].wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return l=[],m=remoteDb("COMMERCIAL").select("GCL_COMMERCIAL","GCL_ETABLISSEMENT"),k&&m.whereIn("GCL_ETABLISSEMENT",k),c.next=5,m;case 5:return m=c.sent,c.next=8,localDb("users").where("accountType",accountType.SellerAccount).whereIn("cegidId",m.map(function(b){return b.GCL_COMMERCIAL}));case 8:b=c.sent,n=_createForOfIteratorHelper(b),c.prev=10,p=function(){var c=o.value,a=m.find(function(a){return a.GCL_COMMERCIAL===c.cegidId});return a?void(c.defaultStore=a.GCL_ETABLISSEMENT,c.cegidRole="SELLER",c.defaultStore&&!c.accessStores.includes(c.defaultStore)&&c.accessStores.push(c.defaultStore),l.push(_objectSpread(_objectSpread({},c),{},{password:void 0}))):"continue"},n.s();case 13:if((o=n.n()).done){c.next=19;break}if(q=p(),"continue"!==q){c.next=17;break}return c.abrupt("continue",17);case 17:c.next=13;break;case 19:c.next=24;break;case 21:c.prev=21,c.t0=c["catch"](10),n.e(c.t0);case 24:return c.prev=24,n.f(),c.finish(24);case 27:return c.abrupt("return",l);case 28:case"end":return c.stop();}},j,null,[[10,21,24,27]])}));return function(){return b.apply(this,arguments)}}(),_getLocalProfiles=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function l(){var m,n,o,p,q,r,s,t,u,v;return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return m=[],b.next=3,localDb("users");case 3:return n=b.sent,o=n.filter(function(b){return b.accountType===accountType.SellerAccount}).map(function(b){return b.cegidId}),p=n.filter(function(b){return b.accountType===accountType.UserAccount}).map(function(b){return b.cegidId}),b.next=8,remoteDb("COMMERCIAL").select("GCL_COMMERCIAL","GCL_ETABLISSEMENT").whereIn("GCL_COMMERCIAL",o);case 8:return q=b.sent,b.next=11,remoteDb("UTILISAT").select("US_UTILISATEUR","US_ETABLISSEMENT","US_GROUPE").whereIn("US_UTILISATEUR",p);case 11:r=b.sent,s=_createForOfIteratorHelper(n),b.prev=13,u=function(){var e=t.value;if(e.accountType===accountType.SellerAccount){var a=q.find(function(a){return a.GCL_COMMERCIAL===e.cegidId});if(!a)return"continue";e.defaultStore=a.GCL_ETABLISSEMENT,e.cegidRole="SELLER"}else{var b=r.find(function(a){return a.US_UTILISATEUR===e.cegidId});if(!b)return"continue";e.defaultStore=b.US_ETABLISSEMENT,e.cegidRole=b.US_GROUPE}e.defaultStore&&!e.accessStores.includes(e.defaultStore)&&e.accessStores.push(e.defaultStore),e.role=abilitiesManager.getDefinitionFor(e.cegidRole,!1),m.push(_objectSpread(_objectSpread({},e),{},{password:void 0}))},s.s();case 16:if((t=s.n()).done){b.next=22;break}if(v=u(),"continue"!==v){b.next=20;break}return b.abrupt("continue",20);case 20:b.next=16;break;case 22:b.next=27;break;case 24:b.prev=24,b.t0=b["catch"](13),s.e(b.t0);case 27:return b.prev=27,s.f(),b.finish(27);case 30:return b.abrupt("return",m);case 31:case"end":return b.stop();}},l,null,[[13,24,27,30]])}));return function(){return b.apply(this,arguments)}}(),massUpdate=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function d(e,b){return _regenerator["default"].wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.abrupt("return",localDb("users").update(b).whereIn("id",e));case 1:case"end":return c.stop();}},d)}));return function(){return b.apply(this,arguments)}}();function getSubordinatesFor(){return _getSubordinatesFor.apply(this,arguments)}function _getSubordinatesFor(){return _getSubordinatesFor=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function f(g){var b,h,i;return _regenerator["default"].wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return b=g.definition.priority,c.next=3,g.getStores();case 3:return h=c.sent.map(function(b){return b.id}),c.next=6,_getLocalProfiles();case 6:return i=c.sent.filter(function(c){return b<c.role.priority&&h.some(function(a){return c.accessStores.includes(a)})}),c.abrupt("return",i);case 8:case"end":return c.stop();}},f)})),_getSubordinatesFor.apply(this,arguments)}module.exports={checkLogin:checkLogin,getUserById:getUserById,listLocalAndRemoteProfiles:listLocalAndRemoteProfiles,updateLastSeen:updateLastSeen,updateUser:updateUser,importUser:importUser,listLocalSellers:listLocalSellers,massUpdate:massUpdate,getSubordinatesFor:getSubordinatesFor};