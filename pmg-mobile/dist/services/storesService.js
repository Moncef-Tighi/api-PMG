"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));function _createForOfIteratorHelper(i,j){var b="undefined"!=typeof Symbol&&i[Symbol.iterator]||i["@@iterator"];if(!b){if(Array.isArray(i)||(b=_unsupportedIterableToArray(i))||j&&i&&"number"==typeof i.length){b&&(i=b);var k=0,l=function(){};return{s:l,n:function(){return k>=i.length?{done:!0}:{done:!1,value:i[k++]}},e:function(b){throw b},f:l}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var e,m=!0,n=!1;return{s:function(){b=b.call(i)},n:function(){var c=b.next();return m=c.done,c},e:function(b){n=!0,e=b},f:function a(){try{m||null==b["return"]||b["return"]()}finally{if(n)throw a}}}}function _unsupportedIterableToArray(d,a){if(d){if("string"==typeof d)return _arrayLikeToArray(d,a);var b=Object.prototype.toString.call(d).slice(8,-1);return"Object"===b&&d.constructor&&(b=d.constructor.name),"Map"===b||"Set"===b?Array.from(d):"Arguments"===b||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(b)?_arrayLikeToArray(d,a):void 0}}function _arrayLikeToArray(e,a){(null==a||a>e.length)&&(a=e.length);for(var f=0,g=Array(a);f<a;f++)g[f]=e[f];return g}var _require=require("../lib/debug"),d_store=_require.d_store,_require2=require("../lib/db"),remoteDb=_require2.remoteDb,localDb=_require2.localDb,config=require("../config/config"),allStores=[],getAllStores=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function h(i,j){var k,l,m,a;return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(i=i||[],j=j||[],allStores.length){b.next=14;break}return d_store("Cache not found or stale => Fetching stores from remoteDb"),b.next=6,remoteDb("ETABLISS").select({id:"ET_ETABLISSEMENT",name:"ET_LIBELLE",zoneId:"ET_LIBREETC",codeDepot:"MDE_DEPOT",typeTarifVenteTtc:"ET_TYPETARIFVTETTC"}).joinRaw("LEFT OUTER JOIN METABDEPOT ON MDE_ETABLISSEMENT = ET_ETABLISSEMENT").where("ET_SURSITE","X");case 6:k=b.sent,l=_createForOfIteratorHelper(k);try{for(a=function(){var c=m.value,a=allStores.find(function(a){return a.id===c.id});a?a.depots.push(c.codeDepot):allStores.push({id:c.id,name:c.name,zoneId:c.zoneId,depots:[c.codeDepot],typeTarifVenteTtc:c.typeTarifVenteTtc})},l.s();!(m=l.n()).done;)a()}catch(b){l.e(b)}finally{l.f()}return b.next=11,_syncStores(allStores.map(function(b){return b.id}));case 11:return b.next=13,_syncZones(allStores.reduce(function(c,a){return a.zoneId&&!c.includes(a.zoneId)&&c.push(a.zoneId),c},[]));case 13:setTimeout(function(){allStores=[],d_store("Cache is stale, deleting cached stores")},1e3*config.storesCacheLifetimeSeconds);case 14:if(!(i.length||j.length)){b.next=16;break}return b.abrupt("return",allStores.filter(function(b){return i.includes(b.id)||j.includes(b.zoneId)}));case 16:return b.abrupt("return",allStores);case 17:case"end":return b.stop();}},h)}));return function(){return b.apply(this,arguments)}}(),_syncStores=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function h(i){var b,j,k,l,m;return _regenerator["default"].wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,localDb.raw("\n        select array_agg(c) as stores\n      from (\n        select distinct(unnest(\"accessStores\"))\n        from users\n      ) as dt(c);\n  ");case 2:if(c.t0=c.sent.rows[0].stores,c.t0){c.next=5;break}c.t0=[];case 5:if(b=c.t0,j=b.filter(function(b){return!i.includes(b)}),!j.length){c.next=27;break}d_store("Found (%d) invalid stores %o valid stores are %o",j.length,j,i),d_store("Cleaning \"user.accessStores\", removing %o",j),k=_createForOfIteratorHelper(j),c.prev=11,k.s();case 13:if((l=k.n()).done){c.next=19;break}return m=l.value,c.next=17,localDb.raw("update users SET \"accessStores\" = array_remove(\"accessStores\", :invalid)",{invalid:m});case 17:c.next=13;break;case 19:c.next=24;break;case 21:c.prev=21,c.t1=c["catch"](11),k.e(c.t1);case 24:return c.prev=24,k.f(),c.finish(24);case 27:case"end":return c.stop();}},h,null,[[11,21,24,27]])}));return function(){return b.apply(this,arguments)}}(),_syncZones=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function h(i){var b,j,k,l,m;return _regenerator["default"].wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,localDb.raw("\n        select array_agg(c) as zones\n      from (\n        select distinct(unnest(\"accessZones\"))\n        from users\n      ) as dt(c);\n  ");case 2:if(c.t0=c.sent.rows[0].zones,c.t0){c.next=5;break}c.t0=[];case 5:if(b=c.t0,j=b.filter(function(b){return!i.includes(b)}),!j.length){c.next=27;break}d_store("Found (%d) invalid zones %o valid zones are %o",j.length,j,i),d_store("Cleaning \"user.accessZones\", removing %o",j),k=_createForOfIteratorHelper(j),c.prev=11,k.s();case 13:if((l=k.n()).done){c.next=19;break}return m=l.value,c.next=17,localDb.raw("update users SET \"accessZones\" = array_remove(\"accessZones\", :invalid)",{invalid:m});case 17:c.next=13;break;case 19:c.next=24;break;case 21:c.prev=21,c.t1=c["catch"](11),k.e(c.t1);case 24:return c.prev=24,k.f(),c.finish(24);case 27:case"end":return c.stop();}},h,null,[[11,21,24,27]])}));return function(){return b.apply(this,arguments)}}(),getStoreById=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function c(d){return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.next=2,getAllStores();case 2:return b.abrupt("return",b.sent.find(function(b){return b.id===d}));case 3:case"end":return b.stop();}},c)}));return function(){return b.apply(this,arguments)}}(),getStoresByZoneId=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function c(d){return _regenerator["default"].wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.next=2,getAllStores();case 2:return b.abrupt("return",b.sent.filter(function(b){return b.zoneId===d}));case 3:case"end":return b.stop();}},c)}));return function(){return b.apply(this,arguments)}}();module.exports={getAllStores:getAllStores,getStoreById:getStoreById,getStoresByZoneId:getStoresByZoneId};