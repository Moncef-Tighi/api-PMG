"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));function ownKeys(e,a){var b=Object.keys(e);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);a&&(c=c.filter(function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable})),b.push.apply(b,c)}return b}function _objectSpread(d){for(var a,e=1;e<arguments.length;e++)a=null==arguments[e]?{}:arguments[e],e%2?ownKeys(Object(a),!0).forEach(function(b){(0,_defineProperty2["default"])(d,b,a[b])}):Object.getOwnPropertyDescriptors?Object.defineProperties(d,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach(function(b){Object.defineProperty(d,b,Object.getOwnPropertyDescriptor(a,b))});return d}function _createForOfIteratorHelper(i,j){var b="undefined"!=typeof Symbol&&i[Symbol.iterator]||i["@@iterator"];if(!b){if(Array.isArray(i)||(b=_unsupportedIterableToArray(i))||j&&i&&"number"==typeof i.length){b&&(i=b);var k=0,l=function(){};return{s:l,n:function(){return k>=i.length?{done:!0}:{done:!1,value:i[k++]}},e:function(b){throw b},f:l}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var e,m=!0,n=!1;return{s:function(){b=b.call(i)},n:function(){var c=b.next();return m=c.done,c},e:function(b){n=!0,e=b},f:function a(){try{m||null==b["return"]||b["return"]()}finally{if(n)throw a}}}}function _unsupportedIterableToArray(d,a){if(d){if("string"==typeof d)return _arrayLikeToArray(d,a);var b=Object.prototype.toString.call(d).slice(8,-1);return"Object"===b&&d.constructor&&(b=d.constructor.name),"Map"===b||"Set"===b?Array.from(d):"Arguments"===b||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(b)?_arrayLikeToArray(d,a):void 0}}function _arrayLikeToArray(e,a){(null==a||a>e.length)&&(a=e.length);for(var f=0,g=Array(a);f<a;f++)g[f]=e[f];return g}var usersService=require("../services/usersService"),storesService=require("../services/storesService"),_require=require("../middlware/errorHandler"),ForbiddenError=_require.ForbiddenError,NotFoundError=_require.NotFoundError,BadRequestError=_require.BadRequestError,abilitiesManager=require("../services/abilitiesManager"),getValidatorMiddleware=require("../middlware/validator"),updateRequest=require("../validation/user_update"),importRequest=require("../validation/user_import"),authorizeRequest=require("../validation/user_authorize"),_require2=require("../enums/modules"),modules=_require2.modules,_require3=require("../lib/db"),localDb=_require3.localDb,moment=require("moment"),index=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function i(j,b,c){var d,k,l,m;return _regenerator["default"].wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,j.abilities.getModules().includes(modules.UsersModule);case 2:if(e.sent){e.next=4;break}return e.abrupt("return",c(new ForbiddenError));case 4:return e.next=6,usersService.listLocalAndRemoteProfiles();case 6:d=e.sent,k=_createForOfIteratorHelper(d),e.prev=8,k.s();case 10:if((l=k.n()).done){e.next=18;break}return m=l.value,m.role=abilitiesManager.getDefinitionFor(m.cegidRole),e.next=15,storesService.getStoreById(m.defaultStore);case 15:m.defaultStore=e.sent;case 16:e.next=10;break;case 18:e.next=23;break;case 20:e.prev=20,e.t0=e["catch"](8),k.e(e.t0);case 23:return e.prev=23,k.f(),e.finish(23);case 26:b.send(d);case 27:case"end":return e.stop();}},i,null,[[8,20,23,26]])}));return function(){return b.apply(this,arguments)}}(),updateMethod=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function g(h,b,c){var d,i;return _regenerator["default"].wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return d=h.params.id,e.next=3,h.abilities.canManageUsers();case 3:if(e.sent){e.next=5;break}return e.abrupt("return",c(new ForbiddenError));case 5:return h.validated.password||delete h.validated.password,e.next=8,usersService.updateUser(d,_objectSpread(_objectSpread({},h.validated),{},{updatedById:h.user.id,updatedAt:localDb.fn.now()}));case 8:if(i=e.sent,!i.error){e.next=11;break}return e.abrupt("return",c(new BadRequestError(i.error)));case 11:if(0!==i){e.next=13;break}return e.abrupt("return",c(new NotFoundError));case 13:b.send({count:i});case 14:case"end":return e.stop();}},g)}));return function(){return b.apply(this,arguments)}}(),update=[getValidatorMiddleware(updateRequest,"body"),updateMethod],importMethod=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function g(h,b,c){var d,i;return _regenerator["default"].wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return d=h.params.cegidId,e.next=3,h.abilities.canManageUsers();case 3:if(e.sent){e.next=5;break}return e.abrupt("return",c(new ForbiddenError));case 5:return e.next=7,usersService.importUser(d,h.validated.cegidRole,{disabled:h.validated.disabled,username:h.validated.username,password:h.validated.password,accessStores:h.validated.accessStores,accessZones:h.validated.accessZones,createdById:h.user.id,updatedById:h.user.id});case 7:if(i=e.sent,!i.error){e.next=10;break}return e.abrupt("return",c(new BadRequestError(i.error)));case 10:b.send({id:i});case 11:case"end":return e.stop();}},g)}));return function(){return b.apply(this,arguments)}}(),import_=[getValidatorMiddleware(importRequest,"body"),importMethod],mySellers=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function k(l,b,c){var d,m,n,o,p,q;return _regenerator["default"].wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.abilities.getModules().includes(modules.ShiftsModule);case 2:if(e.sent){e.next=4;break}return e.abrupt("return",c(new ForbiddenError));case 4:return e.next=6,l.abilities.getStores();case 6:return d=e.sent.map(function(b){return b.id}),e.next=9,usersService.listLocalSellers(d);case 9:m=e.sent,n=abilitiesManager.getDefinitionFor("SELLER"),o=_createForOfIteratorHelper(m),e.prev=12,o.s();case 14:if((p=o.n()).done){e.next=22;break}return q=p.value,q.role=n,e.next=19,storesService.getStoreById(q.defaultStore);case 19:q.defaultStore=e.sent;case 20:e.next=14;break;case 22:e.next=27;break;case 24:e.prev=24,e.t0=e["catch"](12),o.e(e.t0);case 27:return e.prev=27,o.f(),e.finish(27);case 30:b.send(m);case 31:case"end":return e.stop();}},k,null,[[12,24,27,30]])}));return function(){return b.apply(this,arguments)}}(),authorizeMethod=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function g(h,b,c){var d,i;return _regenerator["default"].wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,h.abilities.getModules().includes(modules.ShiftsModule);case 2:if(e.sent){e.next=4;break}return e.abrupt("return",c(new ForbiddenError));case 4:if(d=null,null===h.validated.until){e.next=10;break}if(d=moment("".concat(moment().format("YYYY-MM-DD")," ").concat(h.validated.until,":00")),!d.isBefore(moment())){e.next=9;break}return e.abrupt("return",c(new BadRequestError("L'heure est d\xE9ja pass\xE9")));case 9:d=d.format("YYYY-MM-DD HH:mm:ssZ");case 10:return e.next=12,usersService.massUpdate(h.validated.ids,{activeUntil:d});case 12:if(i=e.sent,i===h.validated.ids.length){e.next=15;break}return e.abrupt("return",c(new BadRequestError("La mise \xE0 jour \xE0 partiellement \xE9chou\xE9e")));case 15:b.send({count:i});case 16:case"end":return e.stop();}},g)}));return function(){return b.apply(this,arguments)}}(),authorize=[getValidatorMiddleware(authorizeRequest,"body"),authorizeMethod];module.exports={index:index,update:update,import_:import_,mySellers:mySellers,authorize:authorize};