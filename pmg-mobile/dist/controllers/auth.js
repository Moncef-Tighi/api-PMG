"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));function ownKeys(e,a){var b=Object.keys(e);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);a&&(c=c.filter(function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable})),b.push.apply(b,c)}return b}function _objectSpread(d){for(var a,e=1;e<arguments.length;e++)a=null==arguments[e]?{}:arguments[e],e%2?ownKeys(Object(a),!0).forEach(function(b){(0,_defineProperty2["default"])(d,b,a[b])}):Object.getOwnPropertyDescriptors?Object.defineProperties(d,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach(function(b){Object.defineProperty(d,b,Object.getOwnPropertyDescriptor(a,b))});return d}var usersService=require("../services/usersService"),jwt=require("../lib/jwt"),getValidatorMiddleware=require("../middlware/validator"),_require=require("../middlware/errorHandler"),BadRequestError=_require.BadRequestError,NotFoundError=_require.NotFoundError,authLoginRequst=require("../validation/authLogin"),updateProfileRequest=require("../validation/auth_update_profile"),abilitiesManager=require("../services/abilitiesManager"),storesService=require("../services/storesService"),_require2=require("../enums/accountType"),accountType=_require2.accountType,turnoverStats=require("../services/turnoverStats"),moment=require("moment"),_require3=require("../lib/debug"),d_auth=_require3.d_auth,loginMethod=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function n(o,b,c){var d,p,q,r,s,t,u,v,w;return _regenerator["default"].wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return d=o.validated,p=d.username,q=d.password,e.next=3,usersService.checkLogin(p,q);case 3:if(r=e.sent,r){e.next=6;break}return e.abrupt("return",c(new BadRequestError("Utilisateur ou mot de passe invalide")));case 6:return e.next=8,usersService.getUserById(r);case 8:if(s=e.sent,s.defaultStore){e.next=12;break}return d_auth("User could not connect because no defaultStore were set !"),e.abrupt("return",c(new BadRequestError("Vous ne pouvez vous connecter car vous n'\xEAtes affect\xE9 \xE0 aucun magasin par defaut")));case 12:return e.next=14,storesService.getStoreById(s.defaultStore);case 14:if(t=e.sent,t){e.next=18;break}return d_auth("User could not connect because no defaultStore were found !"),e.abrupt("return",c(new BadRequestError("Vous ne pouvez vous connecter car votre magasin par d\xE9faut est introuvable ou ferm\xE9")));case 18:if("SELLER"!==s.cegidRole||s.activeUntil&&!moment(s.activeUntil).isBefore(moment())){e.next=20;break}return e.abrupt("return",c(new BadRequestError("Vous n'etes pas autoris\xE9 a vous connecter (Shift)","SHIFT")));case 20:return d_auth("User authenticated %O",s),u=abilitiesManager.getAbilitiesFor(s),e.next=24,u.getStores();case 24:return v=e.sent,w=jwt.sign({id:r}),e.next=28,usersService.updateLastSeen(r);case 28:return e.t0=b,e.t1=w,e.t2=s.username,e.next=33,u.getModules();case 33:e.t3=e.sent,e.t4=v,e.t5=u.definition,e.t6=t,e.t7={token:e.t1,username:e.t2,modules:e.t3,accessStores:e.t4,role:e.t5,defaultStore:e.t6},e.t0.send.call(e.t0,e.t7);case 39:case"end":return e.stop();}},n)}));return function(){return b.apply(this,arguments)}}(),login=[getValidatorMiddleware(authLoginRequst,"body"),loginMethod],profile=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function e(f,b){var c;return _regenerator["default"].wrap(function(d){for(;;)switch(d.prev=d.next){case 0:return d.t0=_objectSpread,d.t1=_objectSpread({},f.user),d.t2={},d.next=5,abilitiesManager.getDefinitionFor(f.user.cegidRole);case 5:return d.t3=d.sent,d.next=8,storesService.getStoreById(f.user.defaultStore);case 8:if(d.t4=d.sent,d.t5={role:d.t3,defaultStore:d.t4},c=(0,d.t0)(d.t1,d.t2,d.t5),c.accountType!==accountType.SellerAccount){d.next=16;break}return d.next=14,turnoverStats.getSellerTurnover(c.cegidId);case 14:c.turnover=d.sent,console.log(c.turnover);case 16:b.send(c);case 17:case"end":return d.stop();}},e)}));return function(){return b.apply(this,arguments)}}(),updatePasswordMethod=function(){var b=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function j(k,b,c){var d,l,m,n,o;return _regenerator["default"].wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return d=k.validated,l=d.oldPassword,m=d.newPassword,n=d.newPasswordConfirm,console.log("========================================"),e.next=4,usersService.checkLogin(k.user.username,l);case 4:if(e.sent){e.next=6;break}return e.abrupt("return",c(new BadRequestError("Ancien mot de passe invalide")));case 6:if(m===n){e.next=8;break}return e.abrupt("return",c(new BadRequestError("La confirmation de mot de passe a \xE9chou\xE9")));case 8:if(m){e.next=10;break}return e.abrupt("return",c(new BadRequestError("La nouveau mot de passe ne peut etre vide")));case 10:return e.next=12,usersService.updateUser(k.user.id,{password:m});case 12:if(o=e.sent,!o.error){e.next=15;break}return e.abrupt("return",c(new BadRequestError(o.error)));case 15:if(1===o){e.next=17;break}return e.abrupt("return",c(new NotFoundError));case 17:b.send({count:o});case 18:case"end":return e.stop();}},j)}));return function(){return b.apply(this,arguments)}}(),updatePassword=[getValidatorMiddleware(updateProfileRequest,"body"),updatePasswordMethod];module.exports={login:login,profile:profile,updatePassword:updatePassword};