"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),userService=require("../services/usersService"),abilitiesManager=require("../services/abilitiesManager"),moment=require("moment"),_require=require("../middlware/errorHandler"),UnauthorizedError=_require.UnauthorizedError,_require2=require("../lib/debug"),d_auth=_require2.d_auth;function userMiddlware(){return _userMiddlware.apply(this,arguments)}function _userMiddlware(){return _userMiddlware=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function f(g,a,b){var c;return _regenerator["default"].wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(g.decoded){d.next=2;break}return d.abrupt("return",b());case 2:return d.next=4,userService.getUserById(g.decoded.id);case 4:if(c=d.sent,c){d.next=7;break}return d.abrupt("return",b());case 7:if(d_auth("Found valid user %o",{id:c.id,username:c.username,role:c.role}),g.user=c,g.abilities=abilitiesManager.getAbilitiesFor(g.user),"SELLER"!==c.cegidRole||c.activeUntil&&!moment(c.activeUntil).isBefore(moment())){d.next=12;break}return d.abrupt("return",b(new UnauthorizedError));case 12:return d.next=14,userService.updateLastSeen(c.id);case 14:b();case 15:case"end":return d.stop();}},f)})),_userMiddlware.apply(this,arguments)}module.exports={userMiddlware:userMiddlware};