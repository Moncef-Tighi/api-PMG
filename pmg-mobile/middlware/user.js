"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),userService=require("../services/usersService"),abilitiesManager=require("../services/abilitiesManager"),moment=require("moment"),_require=require("../middlware/errorHandler"),UnauthorizedError=_require.UnauthorizedError,_require2=require("../lib/debug"),d_auth=_require2.d_auth;function userMiddlware(){return _userMiddlware.apply(this,arguments)}function _userMiddlware(){return _userMiddlware=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c,d){var e;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(b.decoded){a.next=2;break}return a.abrupt("return",d());case 2:return a.next=4,userService.getUserById(b.decoded.id);case 4:if(e=a.sent,e){a.next=7;break}return a.abrupt("return",d());case 7:if(d_auth("Found valid user %o",{id:e.id,username:e.username,role:e.role}),b.user=e,b.abilities=abilitiesManager.getAbilitiesFor(b.user),"SELLER"!==e.cegidRole||e.activeUntil&&!moment(e.activeUntil).isBefore(moment())){a.next=12;break}return a.abrupt("return",d(new UnauthorizedError));case 12:return a.next=14,userService.updateLastSeen(e.id);case 14:d();case 15:case"end":return a.stop();}},a)})),_userMiddlware.apply(this,arguments)}module.exports={userMiddlware:userMiddlware};