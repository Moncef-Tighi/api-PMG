"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}var storeRequest=require("../validation/feedback_store"),updateRequest=require("../validation/feedback_update"),getValidatorMiddleware=require("../middlware/validator"),_require=require("../middlware/errorHandler"),ForbiddenError=_require.ForbiddenError,NotFoundError=_require.NotFoundError,_require2=require("../lib/db"),localDb=_require2.localDb,_require3=require("../enums/modules"),modules=_require3.modules,index=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c,d){var e;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,b.abilities.getModules().includes(modules.FeedbacksModule);case 2:if(a.sent){a.next=4;break}return a.abrupt("return",d(new ForbiddenError));case 4:return e=localDb("links").select(localDb.raw("links.*"),localDb.raw("uc.username as \"createdBy\""),localDb.raw("uu.username as \"updatedBy\"")).joinRaw("LEFT JOIN users uc ON (\"links\".\"createdById\" = uc.id)").joinRaw("LEFT JOIN users uu ON (\"links\".\"updatedById\" = uu.id)").orderByRaw("\"links\".\"createdAt\" DESC"),a.next=7,b.abilities.restrictFeedbacksQuery(e);case 7:return a.t0=c,a.next=10,e;case 10:return a.t1=a.sent,a.next=13,b.abilities.canManageFeedbacks();case 13:a.t2=a.sent,a.t3={canManage:a.t2},a.t4={data:a.t1,metadata:a.t3},a.t0.send.call(a.t0,a.t4);case 17:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),storeMethod=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c,d){var e;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,b.abilities.canManageFeedbacks();case 2:if(a.sent){a.next=4;break}return a.abrupt("return",d(new ForbiddenError));case 4:return a.next=6,localDb("links").insert(_objectSpread(_objectSpread({},b.validated),{},{createdById:b.user.id})).returning("id");case 6:e=a.sent,c.send({id:e[0]});case 8:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),store=[getValidatorMiddleware(storeRequest,"body"),storeMethod],updateMethod=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c,d){var e,f;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return e=b.params.id,a.next=3,b.abilities.canManageFeedbacks();case 3:if(a.sent){a.next=5;break}return a.abrupt("return",d(new ForbiddenError));case 5:return a.next=7,localDb("links").update(_objectSpread(_objectSpread({},b.validated),{},{updatedById:b.user.id,updatedAt:localDb.fn.now()})).where("id",e);case 7:if(f=a.sent,0!==f){a.next=10;break}return a.abrupt("return",d(new NotFoundError));case 10:c.send({result:f});case 11:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),update=[getValidatorMiddleware(updateRequest,"body"),updateMethod],destroy=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c,d){var e,f;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return e=b.params.id,a.next=3,b.abilities.canManageFeedbacks();case 3:if(a.sent){a.next=5;break}return a.abrupt("return",d(new ForbiddenError));case 5:return a.next=7,localDb("links")["delete"]().where("id",e);case 7:if(f=a.sent,0!==f){a.next=10;break}return a.abrupt("return",d(new NotFoundError));case 10:c.send({result:f});case 11:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}();module.exports={index:index,store:store,update:update,destroy:destroy};