"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}var indexRequest=require("../validation/reports_index"),storeRequest=require("../validation/reports_store"),updateRequest=require("../validation/reports_update"),getValidatorMiddleware=require("../middlware/validator"),_require=require("../middlware/errorHandler"),NotFoundError=_require.NotFoundError,ForbiddenError=_require.ForbiddenError,_require2=require("../enums/reportStatus"),reportStatus=_require2.reportStatus,_require3=require("../enums/modules"),modules=_require3.modules,_require4=require("../lib/db"),localDb=_require4.localDb,config=require("../config/config"),usersService=require("../services/usersService"),abilitiesManager=require("../services/abilitiesManager"),storesService=require("../services/storesService"),indexMethod=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c,d){var e,f,g,h,i,j,k,l,m;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,b.abilities.getModules().includes(modules.ReportsModule);case 2:if(a.sent){a.next=4;break}return a.abrupt("return",d(new ForbiddenError));case 4:return e=b.validated,f=e.page,g=e.status,a.next=7,usersService.getSubordinatesFor(b.abilities);case 7:return h=a.sent,i=localDb({r:"reports"}).select({id:"r.id",status:"r.status",type:"rt.name",codeArticle:"r.codeArticle",notes:"r.notes",storeId:"r.storeId",createdAt:"r.createdAt",closedAt:"r.closedAt",createdBy:"uc.username",closedBy:"uu.username"}).leftJoin({rt:"report_types"},"rt.id","r.typeId").leftJoin({uc:"users"},"r.createdById","uc.id").leftJoin({uu:"users"},"r.closedById","uu.id").where(function(a){a.orWhere("r.createdById",b.user.id),a.orWhereIn("r.createdById",h.map(function(a){return a.id}))}).offset(f*config.results_per_page).limit(config.results_per_page).orderBy("r.createdAt","DESC"),g.length&&i.whereIn("status",g),j=i.clone().clear("select").clear("offset").clear("limit").clearOrder().count("* as total").first(),a.next=13,i;case 13:return k=a.sent,a.next=16,j;case 16:return l=a.sent.total,m=f*config.results_per_page<=l,a.t0=c,a.t1=parseInt(l),a.t2=f,a.t3=k,a.next=24,b.abilities.canManageReports();case 24:a.t4=a.sent,a.t5=m,a.t6={totalCount:a.t1,page:a.t2,data:a.t3,canManage:a.t4,hasMore:a.t5},a.t0.send.call(a.t0,a.t6);case 28:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),index=[getValidatorMiddleware(indexRequest),indexMethod],storeMethod=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c,d){var e;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,b.abilities.getModules().includes(modules.ReportsModule);case 2:if(a.sent){a.next=4;break}return a.abrupt("return",d(new ForbiddenError));case 4:return a.next=6,localDb("reports").insert(_objectSpread(_objectSpread({},b.validated),{},{status:reportStatus.Pending,createdById:b.user.id})).returning("id");case 6:e=a.sent,c.send({id:e[0]});case 8:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),store=[getValidatorMiddleware(storeRequest,"body"),storeMethod],updateMethod=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c,d){var e,f,g,h,i,j,k;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,b.abilities.canManageReports();case 2:if(a.sent){a.next=4;break}return a.abrupt("return",d(new ForbiddenError));case 4:return e=b.params.id,a.next=7,localDb("reports").where("id",e).first();case 7:if(f=a.sent,f){a.next=10;break}return a.abrupt("return",d(new NotFoundError));case 10:return a.next=12,usersService.getUserById(f.createdById);case 12:return g=a.sent,a.next=15,usersService.getSubordinatesFor(b.abilities);case 15:if(h=a.sent,!g||g.id===b.user.id||h.find(function(a){return a.id===g.id})){a.next=18;break}return a.abrupt("return",d(new ForbiddenError));case 18:return i=b.validated.status,j=[reportStatus.Completed,reportStatus.Rejected],a.next=22,localDb("reports").update({status:i,closedById:j?b.user.id:void 0,closedAt:j?localDb.fn.now():void 0}).where("id",e);case 22:if(k=a.sent,0!==k){a.next=25;break}return a.abrupt("return",d(new NotFoundError));case 25:c.send({result:k});case 26:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),update=[getValidatorMiddleware(updateRequest,"body"),updateMethod],getTypes=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c){return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=c,a.next=3,localDb("report_types");case 3:a.t1=a.sent,a.t0.send.call(a.t0,a.t1);case 5:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}();module.exports={index:index,store:store,update:update,getTypes:getTypes};