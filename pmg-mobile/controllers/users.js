"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}function _createForOfIteratorHelper(a,b){var c="undefined"!=typeof Symbol&&a[Symbol.iterator]||a["@@iterator"];if(!c){if(Array.isArray(a)||(c=_unsupportedIterableToArray(a))||b&&a&&"number"==typeof a.length){c&&(a=c);var d=0,e=function(){};return{s:e,n:function n(){return d>=a.length?{done:!0}:{done:!1,value:a[d++]}},e:function e(a){throw a},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var f,g=!0,h=!1;return{s:function s(){c=c.call(a)},n:function n(){var a=c.next();return g=a.done,a},e:function e(a){h=!0,f=a},f:function f(){try{g||null==c["return"]||c["return"]()}finally{if(h)throw f}}}}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(a):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=Array(b);c<b;c++)d[c]=a[c];return d}var usersService=require("../services/usersService"),storesService=require("../services/storesService"),_require=require("../middlware/errorHandler"),ForbiddenError=_require.ForbiddenError,NotFoundError=_require.NotFoundError,BadRequestError=_require.BadRequestError,abilitiesManager=require("../services/abilitiesManager"),getValidatorMiddleware=require("../middlware/validator"),updateRequest=require("../validation/user_update"),importRequest=require("../validation/user_import"),authorizeRequest=require("../validation/user_authorize"),_require2=require("../enums/modules"),modules=_require2.modules,_require3=require("../lib/db"),localDb=_require3.localDb,moment=require("moment"),index=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c,d){var e,f,g,h;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,b.abilities.getModules().includes(modules.UsersModule);case 2:if(a.sent){a.next=4;break}return a.abrupt("return",d(new ForbiddenError));case 4:return a.next=6,usersService.listLocalAndRemoteProfiles();case 6:e=a.sent,f=_createForOfIteratorHelper(e),a.prev=8,f.s();case 10:if((g=f.n()).done){a.next=18;break}return h=g.value,h.role=abilitiesManager.getDefinitionFor(h.cegidRole),a.next=15,storesService.getStoreById(h.defaultStore);case 15:h.defaultStore=a.sent;case 16:a.next=10;break;case 18:a.next=23;break;case 20:a.prev=20,a.t0=a["catch"](8),f.e(a.t0);case 23:return a.prev=23,f.f(),a.finish(23);case 26:c.send(e);case 27:case"end":return a.stop();}},a,null,[[8,20,23,26]])}));return function(){return a.apply(this,arguments)}}(),updateMethod=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c,d){var e,f;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return e=b.params.id,a.next=3,b.abilities.canManageUsers();case 3:if(a.sent){a.next=5;break}return a.abrupt("return",d(new ForbiddenError));case 5:return b.validated.password||delete b.validated.password,a.next=8,usersService.updateUser(e,_objectSpread(_objectSpread({},b.validated),{},{updatedById:b.user.id,updatedAt:localDb.fn.now()}));case 8:if(f=a.sent,!f.error){a.next=11;break}return a.abrupt("return",d(new BadRequestError(f.error)));case 11:if(0!==f){a.next=13;break}return a.abrupt("return",d(new NotFoundError));case 13:c.send({count:f});case 14:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),update=[getValidatorMiddleware(updateRequest,"body"),updateMethod],importMethod=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c,d){var e,f;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return e=b.params.cegidId,a.next=3,b.abilities.canManageUsers();case 3:if(a.sent){a.next=5;break}return a.abrupt("return",d(new ForbiddenError));case 5:return a.next=7,usersService.importUser(e,b.validated.cegidRole,{disabled:b.validated.disabled,username:b.validated.username,password:b.validated.password,accessStores:b.validated.accessStores,accessZones:b.validated.accessZones,createdById:b.user.id,updatedById:b.user.id});case 7:if(f=a.sent,!f.error){a.next=10;break}return a.abrupt("return",d(new BadRequestError(f.error)));case 10:c.send({id:f});case 11:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),import_=[getValidatorMiddleware(importRequest,"body"),importMethod],mySellers=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c,d){var e,f,g,h,i,j;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,b.abilities.getModules().includes(modules.ShiftsModule);case 2:if(a.sent){a.next=4;break}return a.abrupt("return",d(new ForbiddenError));case 4:return a.next=6,b.abilities.getStores();case 6:return e=a.sent.map(function(a){return a.id}),a.next=9,usersService.listLocalSellers(e);case 9:f=a.sent,g=abilitiesManager.getDefinitionFor("SELLER"),h=_createForOfIteratorHelper(f),a.prev=12,h.s();case 14:if((i=h.n()).done){a.next=22;break}return j=i.value,j.role=g,a.next=19,storesService.getStoreById(j.defaultStore);case 19:j.defaultStore=a.sent;case 20:a.next=14;break;case 22:a.next=27;break;case 24:a.prev=24,a.t0=a["catch"](12),h.e(a.t0);case 27:return a.prev=27,h.f(),a.finish(27);case 30:c.send(f);case 31:case"end":return a.stop();}},a,null,[[12,24,27,30]])}));return function(){return a.apply(this,arguments)}}(),authorizeMethod=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c,d){var e,f;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,b.abilities.getModules().includes(modules.ShiftsModule);case 2:if(a.sent){a.next=4;break}return a.abrupt("return",d(new ForbiddenError));case 4:if(e=null,null===b.validated.until){a.next=10;break}if(e=moment("".concat(moment().format("YYYY-MM-DD")," ").concat(b.validated.until,":00")),!e.isBefore(moment())){a.next=9;break}return a.abrupt("return",d(new BadRequestError("L'heure est d\xE9ja pass\xE9")));case 9:e=e.format("YYYY-MM-DD HH:mm:ssZ");case 10:return a.next=12,usersService.massUpdate(b.validated.ids,{activeUntil:e});case 12:if(f=a.sent,f===b.validated.ids.length){a.next=15;break}return a.abrupt("return",d(new BadRequestError("La mise \xE0 jour \xE0 partiellement \xE9chou\xE9e")));case 15:c.send({count:f});case 16:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),authorize=[getValidatorMiddleware(authorizeRequest,"body"),authorizeMethod];module.exports={index:index,update:update,import_:import_,mySellers:mySellers,authorize:authorize};