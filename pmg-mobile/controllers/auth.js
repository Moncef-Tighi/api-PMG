"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}var usersService=require("../services/usersService"),jwt=require("../lib/jwt"),getValidatorMiddleware=require("../middlware/validator"),_require=require("../middlware/errorHandler"),BadRequestError=_require.BadRequestError,NotFoundError=_require.NotFoundError,authLoginRequst=require("../validation/authLogin"),updateProfileRequest=require("../validation/auth_update_profile"),abilitiesManager=require("../services/abilitiesManager"),storesService=require("../services/storesService"),_require2=require("../enums/accountType"),accountType=_require2.accountType,turnoverStats=require("../services/turnoverStats"),moment=require("moment"),_require3=require("../lib/debug"),d_auth=_require3.d_auth,loginMethod=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c,d){var e,f,g,h,i,j,k,l,m;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return e=b.validated,f=e.username,g=e.password,a.next=3,usersService.checkLogin(f,g);case 3:if(h=a.sent,h){a.next=6;break}return a.abrupt("return",d(new BadRequestError("Utilisateur ou mot de passe invalide")));case 6:return a.next=8,usersService.getUserById(h);case 8:if(i=a.sent,i.defaultStore){a.next=12;break}return d_auth("User could not connect because no defaultStore were set !"),a.abrupt("return",d(new BadRequestError("Vous ne pouvez vous connecter car vous n'\xEAtes affect\xE9 \xE0 aucun magasin par defaut")));case 12:return a.next=14,storesService.getStoreById(i.defaultStore);case 14:if(j=a.sent,j){a.next=18;break}return d_auth("User could not connect because no defaultStore were found !"),a.abrupt("return",d(new BadRequestError("Vous ne pouvez vous connecter car votre magasin par d\xE9faut est introuvable ou ferm\xE9")));case 18:if("SELLER"!==i.cegidRole||i.activeUntil&&!moment(i.activeUntil).isBefore(moment())){a.next=20;break}return a.abrupt("return",d(new BadRequestError("Vous n'etes pas autoris\xE9 a vous connecter (Shift)","SHIFT")));case 20:return d_auth("User authenticated %O",i),k=abilitiesManager.getAbilitiesFor(i),a.next=24,k.getStores();case 24:return l=a.sent,m=jwt.sign({id:h}),a.next=28,usersService.updateLastSeen(h);case 28:return a.t0=c,a.t1=m,a.t2=i.username,a.next=33,k.getModules();case 33:a.t3=a.sent,a.t4=l,a.t5=k.definition,a.t6=j,a.t7={token:a.t1,username:a.t2,modules:a.t3,accessStores:a.t4,role:a.t5,defaultStore:a.t6},a.t0.send.call(a.t0,a.t7);case 39:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),login=[getValidatorMiddleware(authLoginRequst,"body"),loginMethod],profile=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c){var d;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=_objectSpread,a.t1=_objectSpread({},b.user),a.t2={},a.next=5,abilitiesManager.getDefinitionFor(b.user.cegidRole);case 5:return a.t3=a.sent,a.next=8,storesService.getStoreById(b.user.defaultStore);case 8:if(a.t4=a.sent,a.t5={role:a.t3,defaultStore:a.t4},d=(0,a.t0)(a.t1,a.t2,a.t5),d.accountType!==accountType.SellerAccount){a.next=16;break}return a.next=14,turnoverStats.getSellerTurnover(d.cegidId);case 14:d.turnover=a.sent,console.log(d.turnover);case 16:c.send(d);case 17:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),updatePasswordMethod=function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(b,c,d){var e,f,g,h,i;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return e=b.validated,f=e.oldPassword,g=e.newPassword,h=e.newPasswordConfirm,console.log("========================================"),a.next=4,usersService.checkLogin(b.user.username,f);case 4:if(a.sent){a.next=6;break}return a.abrupt("return",d(new BadRequestError("Ancien mot de passe invalide")));case 6:if(g===h){a.next=8;break}return a.abrupt("return",d(new BadRequestError("La confirmation de mot de passe a \xE9chou\xE9")));case 8:if(g){a.next=10;break}return a.abrupt("return",d(new BadRequestError("La nouveau mot de passe ne peut etre vide")));case 10:return a.next=12,usersService.updateUser(b.user.id,{password:g});case 12:if(i=a.sent,!i.error){a.next=15;break}return a.abrupt("return",d(new BadRequestError(i.error)));case 15:if(1===i){a.next=17;break}return a.abrupt("return",d(new NotFoundError));case 17:c.send({count:i});case 18:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),updatePassword=[getValidatorMiddleware(updateProfileRequest,"body"),updatePasswordMethod];module.exports={login:login,profile:profile,updatePassword:updatePassword};